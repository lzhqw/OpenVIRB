# 技术文档

## Part 1. 地图-GPS界面实现

### 思路

当往视频中添加数据时，需要将视频时间和fit的时间进行对齐。虽然使用视频和fit中记录的时间可能会更加方便，但是视频文件的时间往往存在一定的问题，比如由于相机设置不正确或经过了转换、处理之后丢失了时间信息，因此常常需要手动对齐。

手动对齐，即拖动视频到position A，然后再拖动GPS数据到position B，通过比对地图与视频中的内容来进行对齐，如下图所示。

![1699456289551](imgs/%E5%9C%B0%E5%9B%BE-%E8%A7%86%E9%A2%91%E7%95%8C%E9%9D%A2.png)

为了完成这一功能我们需要一个界面显示地图，一个界面显示视频。地图界面和视频界面均需要有滑动条，来调整地图中的当前位置以及视频位置。

其中地图使用了[leaflet](https://github.com/Leaflet/Leaflet)（[leaflet教程](https://www.bilibili.com/video/BV1sZ4y1W7mG)）来实现。通过编写一个html文件来实现地图的所有功能，该网页接收`初始坐标`，`放大系数`，`GPS数据`，`当前位置`四个参数来进行绘图。初始坐标和放大系数决定了地图一开始显示的位置以及比例尺，并根据GPS数据绘制轨迹路线，最后通过当前经纬度来绘制一个红点表示当前位置。

地图方面使用`QWebEngineView`将地图显示在GUI的界面中并进行初始化，而不是使用浏览器打开。然后定义一个`Slider`以进行滑动，当滑动时，实时获取position并从GPS数据中获取当前位置，传入html中，并更新地图。

视频方面使用`QVideoWidget`来播放视频，并添加播放/暂停按钮以控制播放。

此外，将视频的滑动条与地图的滑动条进行联动，当滑动视频的滑动条时，地图也会随之移动，然而当滑动地图滑动条的时候，视频不会同步移动。定义前者为联动更新，后者为主动更新。每当主动更新时，记录当前视频位置和GPS位置，后续通过记录的两个位置，并根据视频帧数和fit文件记录间隔就可以计算出视频与数据点的对应关系，即可完成对齐。

### 技术要点

#### 对地图进行操作

对地图的所有操作都通过运行js代码来实现：

```python
self.map_view.page().runJavaScript(code)
```

其中`self.map_view`是创建的地图对象，`code`为一串js代码，一般就是调用某个函数。

#### 滑动条联动

#### pyQT5布局

#### 函数关联

